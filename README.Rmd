---
title: "MaMi.CoDi.Beaty: A Model of Harmony Perception"
output:
  github_document: default
---

```{r, echo=F, message=F, include=F}
devtools::load_all(".")
source('./man/code/plot.R')
source('./man/code/utils.R')
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  warning = FALSE, 
  message = FALSE,
  fig.crop= T
)
plot_fundamental_wavelength <- function(midi) {
  freq = hrep::midi_to_freq(midi)
  wavelength = SPEED_OF_SOUND / freq
  wavenumber = (2 * pi) / wavelength
  tibble::tibble(
    meters=seq(0, wavelength ,0.001),
    amplitude=sin(wavenumber * meters)
  ) %>% ggplot2::ggplot(ggplot2::aes(meters, amplitude)) +
    ggplot2::geom_line()
}
```

# Behavioral

## Manipulating Harmonic Frequencies

```{r, include=F}
timbre_paper = readRDS('./man/data/output/readme.rds')
```

```{r, include=F}
dyads <- timbre_paper %>% dplyr::rowwise() %>% dplyr::mutate(
  type          = metadata$type,
  num_harmonics = metadata$num_harmonics,
  pseudo_octave = metadata$pseudo_octave,
  semitone      = metadata$semitone,
  timbre        = metadata$timbre,
  label         = round(metadata$semitone),
  chord_max     = max(frequencies),
  chord_min     = min(frequencies),
  .before=1
)
```

```{r, fig.height=8, fig.width=12, echo=F, results='asis', message=F}
params = list(
  list(h=10,o=2.0,t='Harmonic'),
  list(h=5, o=2.0,t='5Partials'),
  list(h=5, o=2.0,t='5PartialsNo3'),
  list(h=4, o=2.0,t='Bonang'),
  list(h=1, o=2.0,t='Pure'),
  list(h=10,o=2.1,t='Stretched'),
  list(h=10,o=1.9,t='Compressed'),
  list(h=10,o=2.0,t='M3'),
  list(h=10,o=2.0,t='M6'),
  list(h=10,o=2.0,t='P8')
)

BEHAVIOURAL_SMOOTH_BROAD  <- 0.2
BEHAVIOURAL_SMOOTH_NARROW <- 0.035

p = params %>% purrr::map(\(p) {
  if (p$o==2 & p$h==10 & p$t == 'Harmonic') {
    black_vlines  = c(2,3,4,5,7,8,9,12)
  gray_vlines = c()
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_BROAD
  } else if (p$o==2 & p$h==5 & p$t == '5Partials') {
    black_vlines  = c(3,4,5,7,9,12,14)
  gray_vlines = c()
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_BROAD
  } else if (p$o==2 & p$h==5 & p$t == '5PartialsNo3') {
    black_vlines  = c(4,5,7,9,12,14)
  gray_vlines = c()
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_BROAD
  } else if (p$o==2 & p$h==1 & p$t == 'Pure') {
    black_vlines  = c(7,12)
  gray_vlines = c()
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_BROAD
  } else if (p$o>2 & p$t == 'Stretched') {
    black_vlines  = c(4.2,7.5,9.4,12.78)
  gray_vlines = c()
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_BROAD
  } else if (p$o<2 & p$t == 'Compressed') {
    black_vlines  = c(3.8,4.8,11.1,14.5)
  gray_vlines = c()
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_BROAD
  } else if (p$t == 'Bonang') {
    black_vlines = c(2.60, 4.80, 12.0)
    gray_vlines  = c(7.2, 9.6)
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_BROAD
  } else if (p$t == 'M3') {
    gray_vlines = c(hrep::freq_to_midi(hrep::midi_to_freq(60) * 5/4)-60,4,4.092442)
    black_vlines  = c(3.95)
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_NARROW
  } else if (p$t == 'M6') {
    gray_vlines = c(hrep::freq_to_midi(hrep::midi_to_freq(60) * 5/3)-60,9,8.66952)
    black_vlines  = c(8.78,8.93)
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_NARROW
  } else if (p$t == 'P8') {
    gray_vlines = c(hrep::freq_to_midi(hrep::midi_to_freq(60) * 2/1)-60)
    black_vlines  = c(11.94, 12.08)
    description   = ''
    sigma = BEHAVIOURAL_SMOOTH_NARROW
  }
  
  title = paste(
    p$t,
    '~',
    'Partials:', p$h
  )

  chords <- dyads %>% dplyr::filter(timbre == p$t)

  chords$consonance_z = z_scores(-chords$dissonance)
  chords$majorness_z = z_scores(chords$majorness)
  
  chords$space_consonance = -chords$space_dissonance
  chords$time_consonance = -chords$time_dissonance
  
  chords$space_consonance_z = z_scores(-chords$space_dissonance)
  chords$time_consonance_z = z_scores(-chords$time_dissonance)

  chords$euclids_orchard_height = chords$space_euclids_orchard_height + chords$time_euclids_orchard_height
  chords$euclids_orchard_height_z = z_scores(chords$euclids_orchard_height)
  
  chords$stern_brocot_depth = -chords$stern_brocot_depth
  chords$stern_brocot_depth_z = z_scores(chords$stern_brocot_depth)
  
  chords$stern_brocot_depth_diff_z = z_scores(chords$stern_brocot_depth_diff)
  
  chords$thomaes_function = chords$space_thomae + chords$time_thomae
  chords$thomaes_function_z = z_scores(chords$thomaes_function)
  
  chords$energy_per_cycle = -log2(1+chords$energy_per_cycle)
  chords$energy_per_cycle_z = z_scores(chords$energy_per_cycle)
  
  chords$relative_uncertainty = -chords$relative_uncertainty
  chords$relative_uncertainty_z = z_scores(chords$relative_uncertainty)
  
  chords$time_relative_uncertainty = -chords$time_relative_uncertainty
  chords$space_relative_uncertainty = -chords$space_relative_uncertainty
  
  experiment.rds = paste0('./man/data/input/',
                          p$t,
                          '.rds')
  
  experiment_all = readRDS(experiment.rds)
  
  experiment = experiment_all$profile %>%
    dplyr::rename(semitone=interval)
  
  experiment <- experiment %>% dplyr::mutate(
    consonance = rating
  )
  
  experiment_raw = experiment_all$data %>% 
    dplyr::rename(semitone=interval, 
                  consonance_z=rating)
  
  if (p$t=='Pure') {
    cat('  \n#### Dyads spanning 15 semitones\n')
  }
  if (p$t=='M3') {
    cat('  \n#### Dyads spanning 1 quarter tone\n')
  }
  cat("  \n#####", title, '\n')

  print(plot_semitone_codi(chords, paste('Consonance-Dissonance'),
                           goal=experiment,sigma=sigma,include_points=T,
                           black_vlines=black_vlines,gray_vlines=gray_vlines))
  cat("  \n")
  
  print(plot_semitone_space_time(chords, paste('Space and Time Cycle Lengths'),
                                 goal=experiment,sigma=sigma,include_points=T,
                                 black_vlines=black_vlines,gray_vlines=gray_vlines))
  cat("  \n")
  
  print(plot_semitone_stern_brocot_depth(chords,title = "Beating (Stern-Brocot Depth)",
                                         goal=experiment,sigma=sigma,include_points=T,include_line=T,
                                         black_vlines = black_vlines,gray_vlines  = gray_vlines)
  )
  cat("  \n")
  
  print(plot_semitone_energy_per_cycle(chords, paste('Energy Per Cycle'),
                              goal=experiment, sigma=sigma,include_points=T,include_line=T,
                              black_vlines=black_vlines,gray_vlines=gray_vlines))
  cat("  \n")
  
})
```

# Theory 

## Heisenberg Uncertainty

$$
\Delta x \Delta p \ge \frac{\hbar}{2}
$$

## Gabor Uncertainty


$$
\Delta t \Delta \omega \ge \frac{1}{2}
$$

## Relative Uncertainty

### Reference Time Period

$$
\Delta t = T_{ref} = \frac{2 \pi}{\omega_{ref}}
$$
$$
\Delta t \Delta \omega = T_{ref} \Delta \omega = \frac{2 \pi}{\omega_{ref}} \Delta \omega \ge \frac{1}{2}
$$

### Relative Uncertainty Principle

$$
\frac{\Delta \omega}{\omega_{ref}} \ge \frac{1}{4 \pi} \quad \text{and} \quad \frac{\Delta f}{f_{ref}} \ge \frac{1}{4 \pi}\
$$

## Rational Approximation Uncertainty

### Relative Rational Approximation

$$
\Delta f = \bigl| f - \widetilde f \bigr| \quad \text{where} \quad \widetilde f = f_{ref} \frac{a}{b} \quad
\text{and} \quad a \in \mathbb{Z}, b \in \mathbb{N}
$$

$$
\Delta f = f_{ref} \bigl| \frac{f}{f_{ref}} - \frac{a}{b} \bigr|
$$

### Rational Approximation Uncertainty Principle

$$
\frac{\Delta f}{f_{ref}} =  \frac{f_{ref} \bigl| \frac{f}{f_{ref}} - \frac{a}{b} \bigr|}{f_{ref}}  = \bigl| \frac{f}{f_{ref}} - \frac{a}{b}\bigr| \ge \frac{1}{4 \pi}
$$


$$
\bigl| \frac{f}{f_{ref}} - \frac{a}{b}\bigr| \ge \frac{1}{4 \pi}
$$

## Stern-Brocot Traversal

$$
\begin{aligned}
&\mathbf{WHILE} \Bigl|\tfrac{f}{f_{\mathrm{ref}}}-\tfrac{a}{b}\Bigr| \ge \tfrac{1}{4\pi}
\quad\mathbf{DO}\\
&\quad a  \gets  a_{\mathrm{left}} + a_{\mathrm{right}}\\
&\quad b  \gets  b_{\mathrm{left}} + b_{\mathrm{right}}\\
&\quad \mathbf{IF} \tfrac{f}{f_{\mathrm{ref}}} > \tfrac{a}{b} \mathbf{THEN}\\
&\quad\quad a_{\mathrm{left}} \gets a,\quad b_{\mathrm{left}} \gets b\\
&\quad \mathbf{ELSE}\\
&\quad\quad a_{\mathrm{right}} \gets a,\quad b_{\mathrm{right}} \gets b\\
&\quad \mathbf{END\_IF}\\
&\mathbf{END\_WHILE}
\end{aligned}
$$

$$
a \perp b \quad \Longrightarrow \quad  \mathrm{gcd}(a,b)=1
$$

## Fundamental Frequency

$$
f_0 = f_{ref}\frac{\mathrm{gcd}(a_1, a_2, \dots, a_n)}{\mathrm{lcm}(b_1, b_2, \dots, b_n)}, \quad a_i \perp b_i
$$

## Stolzenburg Periodicity Perception

### Fundamental Cycle Length

$$
\Lambda  = \mathrm{lcm}(b_1,b_2,\dots,b_n) \quad \text{when} \quad \gcd(a_1,\dots,a_n)=1
$$

### Psychophysical Periodicity

$$
\Psi  = \log_2 \bigl(\Lambda\bigr) \quad \bigl[\text{units: Sz}\bigr]
$$
